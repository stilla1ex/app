<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analyse Files - Cybersecurity Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Favicon  -->
  <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-100">
  <!-- Dashboard Layout -->
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 p-4">
      <h1 class="text-2xl font-bold text-blue-400 mb-8">4xSecurity</h1>
        <nav>
          <ul class="space-y-2">
            <li><a href="{% url 'dashboard' %}" class="flex items-center p-2 hover:bg-gray-700 rounded dashboard-link nav-link">
                <i class="bi bi-grid-fill nav-icon text-blue-400"></i> <span class="nav-text">Dashboard</span>
            </a></li>
            <li><a href="{% url 'all_files' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-folder-fill nav-icon text-purple-400"></i> <span class="nav-text">All Files</span>
            </a></li>
            <li><a href="{% url 'upload_files' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-upload nav-icon text-green-400"></i> <span class="nav-text">Upload Files</span>
            </a></li>
            <li><a href="{% url 'analysis' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-bar-chart-fill nav-icon text-yellow-400"></i> <span class="nav-text">Analyse Files</span>
            </a></li>
            <li><a href="{% url 'harmful' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-exclamation-triangle-fill nav-icon text-red-400"></i> <span class="nav-text">Harmful Files</span>
            </a></li>
            <li><a href="{% url 'safe' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-check-circle-fill nav-icon text-green-400"></i> <span class="nav-text">Safe Files</span>
            </a></li>
            <li><a href="{% url 'recent_analysis' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-clock-fill nav-icon text-indigo-400"></i> <span class="nav-text">Recent Analyses</span>
            </a></li>
            <li><a href="#" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-file-earmark-fill nav-icon text-pink-400"></i> <span class="nav-text">Sample Pages</span>
            </a></li>
            <li><a href="#" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-people-fill nav-icon text-teal-400"></i> <span class="nav-text">Users</span>
            </a></li>
            <li><a href="#" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-kanban-fill nav-icon text-orange-400"></i> <span class="nav-text">Projects</span>
            </a></li>
            <li><a href="#" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
                <i class="bi bi-tags-fill nav-icon text-cyan-400"></i> <span class="nav-text">Categories</span>
            </a></li>
          </ul>
        </nav>        
  </aside>

  <!-- Main Content -->
<main class="flex-1 p-6 bg-gray-900 text-white">
  <!-- Top Bar -->
  <div class="flex justify-between items-center mb-8">
    <h2 class="text-3xl font-semibold">Malware Analysis Dashboard</h2>
    <div class="flex space-x-4">
      <input type="text" placeholder="Search files..." class="bg-gray-700 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button class="bg-gray-700 p-2 rounded-lg hover:bg-gray-600 transition duration-200">üîî</button>
      <button class="bg-gray-700 p-2 rounded-lg hover:bg-gray-600 transition duration-200">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- Action Buttons Section -->
  <div class="flex space-x-4 mb-8">
    <button id="choose-file-btn" class="bg-blue-600 px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
      Choose File to Analyze
    </button>
    <button id="analyze-btn" class="bg-green-600 px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200">
      Analyze
    </button>
    <button id="reanalyze-btn" class="bg-yellow-600 px-6 py-2 rounded-lg hover:bg-yellow-700 transition duration-200">
      Reanalyze
    </button>
    <button id="download-report-btn" class="bg-purple-600 px-6 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
      Download Report
    </button>
  </div>

  <!-- Analysis Results Section -->
  <div class="bg-gray-800 p-6 rounded-lg mb-8">
    <h3 class="text-xl font-semibold text-gray-300 mb-4">Analysis Results</h3>
    <div id="analysis-results" class="space-y-4">
      <!-- Results will be dynamically populated here -->
      <div class="p-4 bg-gray-700 rounded-lg">
        <p class="text-gray-300">No file analyzed yet. Please choose a file to analyze.</p>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-gray-800 p-6 rounded-lg">
      <h3 class="text-xl font-semibold text-gray-300 mb-4">File Analysis Overview</h3>
      <div class="h-[300px]">
        <canvas id="fileAnalysisChart"></canvas>
      </div>
    </div>
    <div class="bg-gray-800 p-6 rounded-lg">
      <h3 class="text-xl font-semibold text-gray-300 mb-4">Threat Distribution</h3>
      <div class="h-[300px]">
        <canvas id="threatDistributionChart"></canvas>
      </div>
    </div>
  </div>

  <!-- File Selection Modal (Hidden by default) -->
  <div id="file-selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-1/3">
      <h3 class="text-xl font-semibold text-gray-300 mb-4">Choose a File to Analyze</h3>
      <div id="file-list" class="space-y-4">
        <!-- Files will be dynamically populated here -->
      </div>
      <div class="flex justify-end mt-6">
        <button id="close-modal-btn" class="bg-gray-700 px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
          Close
        </button>
      </div>
    </div>
  </div>
</main>

<!-- Script for Modal Interaction and AJAX -->
<script>
  // Open file selection modal and fetch files from Django backend
  document.getElementById('choose-file-btn').addEventListener('click', async () => {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '<p class="text-gray-300">Loading files...</p>';

    // Fetch files from Django backend
    try {
      const response = await fetch('/api/files/'); // Replace with your Django API endpoint
      const files = await response.json();

      // Clear loading message and populate file list
      fileList.innerHTML = '';
      files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'p-4 bg-gray-700 rounded-lg hover:bg-gray-600 cursor-pointer';
        fileItem.innerHTML = `<p class="text-gray-300">${file.name}</p>`;
        fileItem.addEventListener('click', () => {
          alert(`Selected file: ${file.name}`);
          // Add logic to handle file selection
        });
        fileList.appendChild(fileItem);
      });
    } catch (error) {
      fileList.innerHTML = '<p class="text-gray-300">Failed to load files.</p>';
    }

    // Show modal
    document.getElementById('file-selection-modal').classList.remove('hidden');
  });

  // Close file selection modal
  document.getElementById('close-modal-btn').addEventListener('click', () => {
    document.getElementById('file-selection-modal').classList.add('hidden');
  });

  // Analyze button functionality
  document.getElementById('analyze-btn').addEventListener('click', () => {
    alert('Analysis started...');
    // Add logic to start analysis
  });

  // Reanalyze button functionality
  document.getElementById('reanalyze-btn').addEventListener('click', () => {
    alert('Reanalysis started...');
    // Add logic to reanalyze
  });

  // Download report button functionality
  document.getElementById('download-report-btn').addEventListener('click', () => {
    alert('Report downloaded!');
    // Add logic to download report
  });
</script>
  </div>

  <!-- Full-page loading overlay (hidden by default) -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
    <div class="flex flex-col items-center">
      <!-- Spinning Loader -->
      <div class="w-16 h-16 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>
      <p class="mt-4 text-gray-300 font-semibold">Analyzing...</p>
    </div>
  </div>

  <script>
    function showLoading() {
      document.getElementById("loading-overlay").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loading-overlay").classList.add("hidden");
    }

    // Function to analyze a file
    function analyseFile(fileId) {
      // Show loading overlay
      showLoading();

      // Send a request to the server to analyze the file
      fetch(`/analyse/${fileId}/`)
        .then(response => response.json())
        .then(data => {
          // Update the threat level in the UI
          const fileElement = document.getElementById(`file-${fileId}`);
          const threatLevelElement = fileElement.querySelector('.threat-level');
          threatLevelElement.textContent = data.threat_level;

          // Update the threat level class for styling
          threatLevelElement.className = 'threat-level ' + data.threat_level;

          // Display analysis results
          const analysisResults = document.getElementById('analysis-results');
          analysisResults.innerHTML = `
            <div class="bg-gray-700 p-4 rounded">
              <p class="text-sm">File: <span class="font-bold">${data.file_name}</span></p>
              <p class="text-sm">Status: <span class="${data.threat_level === 'safe' ? 'text-green-400' : data.threat_level === 'harmful' ? 'text-red-400' : 'text-yellow-400'}">${data.threat_level}</span></p>
              <p class="text-sm">Details: ${data.threat_level === 'safe' ? 'No threats detected.' : data.threat_level === 'harmful' ? 'Malware detected.' : 'Potential threats detected.'}</p>
            </div>
          `;

          // Hide loading overlay
          hideLoading();
        })
        .catch(error => {
          console.error('Error:', error);
          // Hide loading overlay
          hideLoading();
        });
    }

    // File Analysis Chart
    const fileAnalysisCtx = document.getElementById('fileAnalysisChart').getContext('2d');
    const fileAnalysisChart = new Chart(fileAnalysisCtx, {
      type: 'bar',
      data: {
        labels: ['Safe Files', 'Harmful Files', 'Unknown'],
        datasets: [{
          label: 'File Analysis',
          data: [120, 15, 5],
          backgroundColor: ['#10B981', '#EF4444', '#6B7280'],
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // Threat Distribution Chart
    const threatDistributionCtx = document.getElementById('threatDistributionChart').getContext('2d');
    const threatDistributionChart = new Chart(threatDistributionCtx, {
      type: 'pie',
      data: {
        labels: ['Malware', 'Phishing', 'Ransomware', 'Other'],
        datasets: [{
          label: 'Threat Distribution',
          data: [40, 30, 20, 10],
          backgroundColor: ['#EF4444', '#F59E0B', '#3B82F6', '#6B7280'],
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      }
    });
  </script>
</body>
</html>