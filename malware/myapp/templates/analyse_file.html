<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analyze File</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
  <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body class="bg-gray-900 text-gray-100">
  <!-- Dashboard Layout -->
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 p-4">
      <h1 class="text-2xl font-bold text-blue-400 mb-8">4xSecurity</h1>
      <nav>
        <ul class="space-y-2">
          <li><a href="{% url 'dashboard' %}" class="flex items-center p-2 hover:bg-gray-700 rounded dashboard-link nav-link">
              <i class="bi bi-grid-fill nav-icon text-blue-400"></i> <span class="nav-text">Dashboard</span>
          </a></li>
          <li><a href="{% url 'all_files' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
              <i class="bi bi-folder-fill nav-icon text-purple-400"></i> <span class="nav-text">All Files</span>
          </a></li>
          <li><a href="{% url 'upload_files' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
              <i class="bi bi-upload nav-icon text-green-400"></i> <span class="nav-text">Upload Files</span>
          </a></li>
          <li><a href="{% url 'analysis' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
              <i class="bi bi-bar-chart-fill nav-icon text-yellow-400"></i> <span class="nav-text">Analyse Files</span>
          </a></li>
          <li><a href="{% url 'harmful' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
              <i class="bi bi-exclamation-triangle-fill nav-icon text-red-400"></i> <span class="nav-text">Harmful Files</span>
          </a></li>
          <li><a href="{% url 'safe' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
              <i class="bi bi-check-circle-fill nav-icon text-green-400"></i> <span class="nav-text">Safe Files</span>
          </a></li>
          <li><a href="{% url 'recent_analysis' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
              <i class="bi bi-clock-fill nav-icon text-indigo-400"></i> <span class="nav-text">Recent Analyses</span>
          </a></li>
          <li><a href="{% url 'projects' %}" class="flex items-center p-2 hover:bg-gray-700 rounded nav-link">
              <i class="bi bi-kanban-fill nav-icon text-orange-400"></i> <span class="nav-text">Projects</span>
          </a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <!-- Top Bar -->
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-semibold">Analyse File</h2>
        <div class="flex space-x-4">
          <input type="text" placeholder="Search..." class="bg-gray-700 p-2 rounded">
          <button class="bg-gray-700 p-2 rounded">üîî</button>
          <button class="bg-gray-700 p-2 rounded">‚öôÔ∏è</button>
        </div>
      </div>

      <!-- File Details -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">File Details</h3>
        <div class="space-y-2">
          <p><span class="font-semibold">File Name:</span> {{ file.file_name }}</p>
          <p><span class="font-semibold">Size:</span> {{ file.file_size|filesizeformat }}</p>
          <p><span class="font-semibold">Status:</span> 
            <span class="{% if file.threat_level == 'safe' %}text-green-400{% elif file.threat_level == 'harmful' %}text-red-400{% else %}text-yellow-400{% endif %}">
              {{ file.get_threat_level_display }}
            </span>
          </p>
          <p><span class="font-semibold">Uploaded At:</span> {{ file.uploaded_at }}</p>
        </div>
      </div>

      <!-- File Metadata -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">File Metadata</h3>
        <div class="space-y-2">
          <p><span class="font-semibold">File Type:</span> {{ file.file_type }}</p>
          <p><span class="font-semibold">MD5 Hash:</span> {{ file.md5_hash }}</p>
          <p><span class="font-semibold">SHA-256 Hash:</span> {{ file.sha256_hash }}</p>
          <p><span class="font-semibold">Uploaded By:</span> {{ file.uploaded_by }}</p>
        </div>
      </div>

      <!-- Behavioral Analysis -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">Behavioral Analysis</h3>
        <div class="space-y-2">
          <p><span class="font-semibold">Processes Spawned:</span> {{ file.processes_spawned|default:"None" }}</p>
          <p><span class="font-semibold">Network Connections:</span> {{ file.network_connections|default:"None" }}</p>
          <p><span class="font-semibold">Files Created/Modified:</span> {{ file.files_created|default:"None" }}</p>
        </div>
      </div>

      <!-- Threat Intelligence -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">Threat Intelligence</h3>
        <div class="space-y-2">
          <p><span class="font-semibold">Known Malware Signatures:</span> {{ file.malware_signatures|default:"None" }}</p>
          <p><span class="font-semibold">Associated Threat Actors:</span> {{ file.threat_actors|default:"None" }}</p>
          <p><span class="font-semibold">First Seen:</span> {{ file.first_seen|default:"Unknown" }}</p>
          <p><span class="font-semibold">Last Seen:</span> {{ file.last_seen|default:"Unknown" }}</p>
        </div>
      </div>

      <!-- Static Analysis -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">Static Analysis</h3>
        <div class="space-y-2">
          <p><span class="font-semibold">Extracted Strings:</span></p>
          <pre class="bg-gray-700 p-2 rounded text-sm text-gray-300">{{ file.extracted_strings|default:"None" }}</pre>
          <p><span class="font-semibold">Embedded URLs:</span> {{ file.embedded_urls|default:"None" }}</p>
          <p><span class="font-semibold">Suspicious Patterns:</span> {{ file.suspicious_patterns|default:"None" }}</p>
        </div>
      </div>

      <!-- User Comments -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">User Comments</h3>
        <div class="space-y-4">
          {% for comment in file.comments.all %}
            <div class="bg-gray-700 p-3 rounded">
              <p class="text-gray-300">{{ comment.text }}</p>
              <p class="text-sm text-gray-400">- {{ comment.user.username }}, {{ comment.created_at }}</p>
            </div>
          {% empty %}
            <p class="text-gray-400">No comments yet.</p>
          {% endfor %}

          <form method="post" action="" class="mt-4">
            {% csrf_token %}
            <textarea name="comment" class="w-full px-3 py-2 bg-gray-700 text-white rounded focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Add a comment..." required></textarea>
            <button type="submit" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Submit Comment</button>
          </form>
        </div>
      </div>

      <!-- Related Files -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">Related Files</h3>
        <div class="space-y-2">
          {% for related_file in file.related_files.all %}
            <div class="bg-gray-700 p-3 rounded">
              <p><span class="font-semibold">File Name:</span> {{ related_file.file_name }}</p>
              <p><span class="font-semibold">Threat Level:</span> 
                <span class="{% if related_file.threat_level == 'safe' %}text-green-400{% elif related_file.threat_level == 'harmful' %}text-red-400{% else %}text-yellow-400{% endif %}">
                  {{ related_file.get_threat_level_display }}
                </span>
              </p>
              <a href="{% url 'analyse_file' related_file.id %}" class="text-blue-400 hover:text-blue-300">View Details</a>
            </div>
          {% empty %}
            <p class="text-gray-400">No related files found.</p>
          {% endfor %}
        </div>
      </div>

      <!-- Export Options -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">Export Analysis</h3>
        <div class="flex space-x-4">
          <a href="" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            <i class="bi bi-file-earmark-pdf"></i> Export as PDF
          </a>
          <a href="" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            <i class="bi bi-file-earmark-code"></i> Export as JSON
          </a>
        </div>
      </div>

      <!-- File Actions -->
      <div class="bg-gray-800 p-6 rounded-lg mb-8">
        <h3 class="text-gray-400 mb-4">File Actions</h3>
        <div class="flex space-x-4">
          <button onclick="quarantineFile({{ file.id }})" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
            <i class="bi bi-shield-lock"></i> Quarantine File
          </button>
          <button onclick="deleteFile({{ file.id }})" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            <i class="bi bi-trash"></i> Delete File
          </button>
          <button onclick="markAsReviewed({{ file.id }})" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            <i class="bi bi-check-circle"></i> Mark as Reviewed
          </button>
        </div>
      </div>
    </main>
  </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-4 text-center">
        <div class="container mx-auto">
          <p class="text-sm">
            &copy; 2023 4xSecurity. All rights reserved. | 
            <a href="#" class="hover:text-gray-300">Privacy Policy</a> | 
            <a href="#" class="hover:text-gray-300">Terms of Service</a>
          </p>
        </div>
      </footer>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
    <div class="flex flex-col items-center">
      <div class="w-16 h-16 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>
      <p class="mt-4 text-gray-300 font-semibold">Loading...</p>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    function triggerAnalysis(fileId) {
      const loadingOverlay = document.getElementById('loading-overlay');
      loadingOverlay.classList.remove('hidden');

      fetch(`/analyse_file/${fileId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
        },
        body: JSON.stringify({}),
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            window.location.reload();
          } else {
            console.error('Failed to re-analyze file:', data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
        })
        .finally(() => {
          loadingOverlay.classList.add('hidden');
        });
    }

    function quarantineFile(fileId) {
      if (confirm('Are you sure you want to quarantine this file?')) {
        fetch(`/quarantine_file/${fileId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
          },
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              window.location.reload();
            } else {
              console.error('Failed to quarantine file:', data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    }

    function deleteFile(fileId) {
      if (confirm('Are you sure you want to delete this file?')) {
        fetch(`/delete_file/${fileId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
          },
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              window.location.href = "{% url 'all_files' %}";
            } else {
              console.error('Failed to delete file:', data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    }

    function markAsReviewed(fileId) {
      fetch(`/mark_as_reviewed/${fileId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
        },
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            window.location.reload();
          } else {
            console.error('Failed to mark as reviewed:', data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }
  </script>
</body>
</html>